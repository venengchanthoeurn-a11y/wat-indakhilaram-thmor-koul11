-- Full Database Setup for Wat Management System

-- Create the new database if it doesn't already exist
CREATE DATABASE IF NOT EXISTS thmako_system;

-- Use the newly created database
USE thmako_system;

-- 1. Table for Monks (ព្រះសង្ឃ)
-- Stores detailed information about each monk.
CREATE TABLE IF NOT EXISTS monks (
    id INT AUTO_INCREMENT PRIMARY KEY,
    khmer_name VARCHAR(255) NOT NULL, -- គោត្តនាម (ខ្មែរ)
    latin_name VARCHAR(255) NULL,     -- គោត្តនាម (ឡាតាំង)
    birth_date DATE NULL,             -- ថ្ងៃខែឆ្នាំកំណើត
    monk_type VARCHAR(50) NOT NULL,   -- ប្រភេទព្រះសង្ឃ (ឧ. ភិក្ខុ, សាមណេរ)
    status VARCHAR(50) NOT NULL DEFAULT 'ផ្ទុក', -- ស្ថានភាពបច្ចុប្បន្ន (ឧ. ផ្ទុក, រៀន)
    role VARCHAR(255) NULL,           -- មុខងារ ឬតួនាទី (ឧ. ព្រះគ្រូ, ព្រះលេខា)
    kuti_id INT NULL,                 -- លេខសម្គាល់កុដិដែលព្រះសង្ឃគង់នៅ (FOREIGN KEY to 'kuti' table)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, -- ពេលវេលាបង្កើតកំណត់ត្រា
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, -- ពេលវេលាធ្វើបច្ចុប្បន្នភាពកំណត់ត្រា
    INDEX (monk_type),
    INDEX (status)
);

-- 2. Table for Kuti (កុដិ)
-- Stores information about the Kuti (living quarters) in the pagoda.
CREATE TABLE IF NOT EXISTS kuti (
    id INT AUTO_INCREMENT PRIMARY KEY,
    kuti_name VARCHAR(255) NOT NULL UNIQUE, -- ឈ្មោះកុដិ (ឧ. មហាកុដិ, កុដិបណ្ណាល័យ)
    description TEXT NULL,                  -- ការពិពណ៌នាអំពីកុដិ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- Add foreign key constraint to monks table after kuti table is created
-- This links monks to their respective kutis.
ALTER TABLE monks
ADD CONSTRAINT fk_monks_kuti
FOREIGN KEY (kuti_id) REFERENCES kuti(id)
ON DELETE SET NULL; -- If a kuti is deleted, set kuti_id in monks to NULL

-- 3. Table for Attendance (វត្តមាន)
-- Records the attendance of monks.
CREATE TABLE IF NOT EXISTS attendance (
    id INT AUTO_INCREMENT PRIMARY KEY,
    monk_id INT NOT NULL,           -- លេខសម្គាល់ព្រះសង្ឃ (FOREIGN KEY to 'monks' table)
    attendance_date DATE NOT NULL,  -- ថ្ងៃខែវត្តមាន
    status VARCHAR(50) NOT NULL,    -- ស្ថានភាពវត្តមាន (ឧ. មាន, អវត្តមាន, ឈឺ, លា)
    notes TEXT NULL,                -- កំណត់ចំណាំ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX (attendance_date),
    INDEX (status),
    CONSTRAINT fk_attendance_monk
        FOREIGN KEY (monk_id) REFERENCES monks(id)
        ON DELETE CASCADE -- If a monk is deleted, delete their attendance records
);

-- 4. Table for Users (អ្នកប្រើប្រាស់)
-- Stores user accounts for logging into the system.
-- The 'password' column will store plain text passwords as requested.
-- WARNING: Passwords are stored in plain text. This is highly INSECURE for production environments.
CREATE TABLE IF NOT EXISTS users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(100) NOT NULL UNIQUE, -- ឈ្មោះអ្នកប្រើប្រាស់
    password VARCHAR(255) NOT NULL,         -- ពាក្យសម្ងាត់ (Plain Text - NOT RECOMMENDED FOR PRODUCTION)
    email VARCHAR(255) NULL,                -- អ៊ីមែល (ស្រេចតែនឹងប្រើ)
    role VARCHAR(50) NOT NULL DEFAULT 'user', -- តួនាទីអ្នកប្រើប្រាស់ (ឧ. admin, co.admin, manager, controller)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- Insert default users into the 'users' table
INSERT INTO users (username, password, role, email) VALUES
('admin', 'admin123', 'admin', 'admin@example.com'),
('co.admin', 'coadmin123', 'co.admin', 'co.admin@example.com'),
('manager', 'manager123', 'manager', 'manager@example.com'),
('controller', 'controller123', 'controller', 'controller@example.com');


-- 5. Table for Logs (កំណត់ហេតុ)
-- Records system activities and changes.
CREATE TABLE IF NOT EXISTS logs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    action TEXT NOT NULL,                   -- សកម្មភាពដែលបានកើតឡើង
    user_id INT NULL,                       -- លេខសម្គាល់អ្នកប្រើប្រាស់ដែលធ្វើសកម្មភាព (FOREIGN KEY to 'users' table)
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP, -- ពេលវេលានៃសកម្មភាព
    CONSTRAINT fk_logs_user
        FOREIGN KEY (user_id) REFERENCES users(id)
        ON DELETE SET NULL -- If a user is deleted, set their user_id in logs to NULL
);
